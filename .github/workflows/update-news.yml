# ============================================
# GitHub Actions 工作流程設定檔
# 功能：自動更新新聞資料
# ============================================

# 工作流程名稱（會顯示在 GitHub Actions 頁面）
name: Auto Update News

# ============================================
# 觸發條件設定
# ============================================
on:
  # 定時觸發器
  schedule:
    # cron 表達式說明：
    # ┌───────────── 分鐘 (0 - 59)
    # │ ┌───────────── 小時 (0 - 23)
    # │ │ ┌───────────── 日期 (1 - 31)
    # │ │ │ ┌───────────── 月份 (1 - 12)
    # │ │ │ │ ┌───────────── 星期 (0 - 6，0 代表星期日)
    # │ │ │ │ │
    # * * * * *
    # 
    # '0 * * * *' = 每小時的第 0 分鐘執行（每小時整點執行一次）
    - cron: '0 * * * *'
  
  # 手動觸發選項（可在 GitHub Actions 頁面手動執行）
  workflow_dispatch:

# ============================================
# 工作任務定義
# ============================================
jobs:
  # 任務 ID：update-news
  update-news:
    # 指定執行環境：使用最新版本的 Ubuntu Linux
    runs-on: ubuntu-latest
    
    # ============================================
    # 執行步驟（按順序執行）
    # ============================================
    steps:
      # --------------------------------------------
      # 步驟 1：檢出程式碼儲存庫
      # --------------------------------------------
      - name: Checkout repository
        # 使用 GitHub 官方提供的 checkout action（版本 3）
        uses: actions/checkout@v3
      
      # --------------------------------------------
      # 步驟 2：設定 Python 環境
      # --------------------------------------------
      - name: Set up Python
        # 使用 GitHub 官方提供的 Python 設定 action（版本 4）
        uses: actions/setup-python@v4
        with:
          # 指定 Python 版本為 3.10
          python-version: '3.10'
      
      # --------------------------------------------
      # 步驟 3：安裝 Python 相依套件
      # --------------------------------------------
      - name: Install dependencies
        # 執行 shell 指令
        run: |
          # 使用 pip 安裝所需的 Python 套件：
          # - requests：用於發送 HTTP 請求
          # - beautifulsoup4：用於解析 HTML 內容
          # - feedparser：用於解析 RSS/Atom 訂閱來源
          pip install requests beautifulsoup4 feedparser
      
      # --------------------------------------------
      # 步驟 4：執行爬蟲腳本
      # --------------------------------------------
      - name: Run scraper
        run: |
          # 執行 scraper.py 腳本來抓取新聞資料
          python scraper.py
      
      # --------------------------------------------
      # 步驟 5：提交並推送變更到儲存庫
      # --------------------------------------------
      - name: Commit and push if changed
        run: |
          # 設定 Git 使用者資訊（使用 GitHub Actions 機器人身份）
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 將 news.json 檔案加入到 Git 暫存區
          git add news.json
          
          # 檢查是否有變更，如果有則提交並推送
          # git diff --quiet：檢查工作區是否有變更
          # git diff --staged --quiet：檢查暫存區是否有變更
          # || 表示：如果前面的指令失敗（有變更），則執行後面的指令
          # $(date '+%Y-%m-%d %H:%M')：在提交訊息中加入當前時間
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto update news $(date '+%Y-%m-%d %H:%M')" && git push)